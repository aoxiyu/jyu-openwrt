name: OpenWrt Builder

on:
  workflow_dispatch:
    inputs:
      CACHE_BUILD:
        description: 'å¯ç”¨ç¼–è¯‘ç¼“å­˜'
        type: boolean
        default: true
      SSH_ACTION:
        description: 'SSHè¿œç¨‹é…ç½®å›ºä»¶'
        type: boolean
        default: false
      CLEAN_CACHE:
        description: 'æ¸…ç†ç¼“å­˜'
        type: boolean
        default: false
  schedule:
    - cron: '0 15 * * 3'  # æ¯å‘¨ä¸‰ä¸‹åˆ3ç‚¹(UTCæ—¶é—´)ï¼ŒåŒ—äº¬æ—¶é—´æ™šä¸Š11ç‚¹

env:
  TZ: Asia/Shanghai
  MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  GITHUB_RELEASE: https://github.com/aoxijy/aoxi-openwrt/releases
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P_SH: diy-part.sh

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout ä»“åº“
      uses: actions/checkout@v4

    - name: æ£€æµ‹è„šæœ¬è®¾ç½®
      run: |
        echo "æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶..."
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "é”™è¯¯: $CONFIG_FILE ä¸å­˜åœ¨!"
          exit 1
        fi
        if [ ! -f "$DIY_P_SH" ]; then
          echo "è­¦å‘Š: $DIY_P_SH ä¸å­˜åœ¨ï¼Œå°†ç»§ç»­ä½¿ç”¨é»˜è®¤é…ç½®"
        fi
        echo "æ‰€æœ‰å¿…è¦æ–‡ä»¶æ£€æŸ¥å®Œæˆ"

    - name: æ¸…ç†ç¼–è¯‘ç¼“å­˜ï¼ˆå¦‚éœ€è¦ï¼‰
      if: inputs.CLEAN_CACHE
      run: |
        echo "æ¸…ç†ç¼–è¯‘ç¼“å­˜..."
        sudo rm -rf ./tmp
        sudo rm -rf ./*.config
        echo "ç¼“å­˜æ¸…ç†å®Œæˆ"

    - name: åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
      run: |
        echo "å®‰è£…ç¼–è¯‘ä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget qemu-utils

    - name: ç¼–è¯‘å‰å‡†å¤‡
      run: |
        echo "è®¾ç½®Gité…ç½®..."
        git config --global user.name "OpenWrt Builder"
        git config --global user.email "builder@openwrt.org"
        echo "å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ..."

    - name: é‡Šæ”¾Ubuntuç£ç›˜ç©ºé—´
      run: |
        echo "é‡Šæ”¾ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo apt-get clean

    - name: åˆ›å»ºæ¨¡æ‹Ÿç‰©ç†ç£ç›˜
      run: |
        echo "åˆ›å»ºè™šæ‹Ÿç£ç›˜..."
        dd if=/dev/zero of=swapfile bs=1M count=2048
        mkswap swapfile
        swapon swapfile
        free -h

    - name: ä¸‹è½½Lean_x86_64æºç 
      run: |
        echo "å…‹éš†æºç ä»“åº“..."
        git clone $REPO_URL openwrt --branch $REPO_BRANCH --depth 1
        cd openwrt

    - name: ç¼“å­˜åŠ é€Ÿ
      if: inputs.CACHE_BUILD
      uses: actions/cache@v3
      with:
        path: openwrt/dl
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('openwrt/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
      run: |
        echo "è®¾ç½®æ—¶åŒº..."
        sudo timedatectl set-timezone $TZ
        echo "å½“å‰æ—¶é—´: $(date)"

    - name: åŠ è½½æº,å®šåˆ¶æ–‡ä»¶å¹¶ç”Ÿæˆè‡ªå®šä¹‰é…ç½®
      run: |
        cd openwrt
        echo "æ›´æ–°å’Œå®‰è£…feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        if [ -f "../$DIY_P_SH" ]; then
          echo "è¿è¡Œè‡ªå®šä¹‰è„šæœ¬..."
          chmod +x "../$DIY_P_SH"
          "../$DIY_P_SH"
        fi
        
        echo "åº”ç”¨é…ç½®æ–‡ä»¶..."
        cp "../$CONFIG_FILE" .config
        make defconfig

    - name: SSHè¿œç¨‹è¿æ¥æœåŠ¡å™¨
      if: inputs.SSH_ACTION
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to: ${{ github.actor }}

    - name: è¾“å‡ºç¼–è¯‘ä¿¡æ¯
      run: |
        cd openwrt
        echo "ç¼–è¯‘ä¿¡æ¯:"
        echo "=========================================="
        make -s info
        echo "=========================================="

    - name: ä¸‹è½½ç¼–è¯‘æ‰€éœ€æ–‡ä»¶
      run: |
        cd openwrt
        echo "ä¸‹è½½ä¾èµ–æ–‡ä»¶..."
        make download -j$(nproc)
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -delete

    - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        echo "å¼€å§‹ç¼–è¯‘..."
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log | grep -E '^(CC|CXX|LD|INSTALL|make)'

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      run: |
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo "ç¼–è¯‘ç›®å½•å¤§å°:"
        du -sh openwrt

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      run: |
        echo "æ•´ç†å›ºä»¶æ–‡ä»¶..."
        cd openwrt/bin/targets/*/*
        mkdir -p firmware
        mv * firmware/ 2>/dev/null || true
        echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
        ls -la firmware/

    - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: openwrt/bin/targets/*/*/firmware/*
        retention-days: 5

    - name: ä¸Šä¼ å›ºä»¶ä¿¡æ¯
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: |
          openwrt/build.log
          openwrt/.config
        retention-days: 5

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
      run: |
        echo "å‡†å¤‡å‘å¸ƒå›ºä»¶..."
        cd openwrt/bin/targets/*/*/firmware
        TAG_NAME="openwrt-$(date +'%Y%m%d-%H%M')"
        
        # åˆ›å»ºå‘å¸ƒ
        RELEASE_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          -d '{"tag_name":"'"$TAG_NAME"'","name":"OpenWrt Build '"$(date +'%Y-%m-%d %H:%M')"'","draft":false,"prerelease":false}' \
          "https://api.github.com/repos/${{ github.repository }}/releases")
        
        RELEASE_ID=$(echo "$RELEASE_RESPONSE" | grep '"id":' | head -1 | awk '{print $2}' | sed 's/[^0-9]*//g')
        
        # ä¸Šä¼ å›ºä»¶æ–‡ä»¶
        for file in *; do
          if [ -f "$file" ]; then
            echo "ä¸Šä¼ æ–‡ä»¶: $file"
            curl -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$file" \
              "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$file"
          fi
        done

    - name: åˆ é™¤è¿è¡Œè®°å½•
      if: always()
      run: |
        echo "æ¸…ç†æ•æ„Ÿä¿¡æ¯..."
        history -c

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶ï¼ˆå¤§äº20ä¸ªåˆ é™¤å‰é¢çš„ï¼‰
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
      run: |
        echo "æ£€æŸ¥å¹¶æ¸…ç†æ—§å‘å¸ƒ..."
        RELEASES=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100" | \
          jq -r '.[] | select(.name | contains("OpenWrt Build")) | .id' | head -n 20)
        
        ALL_RELEASES=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100" | \
          jq -r '.[] | select(.name | contains("OpenWrt Build")) | .id')
        
        COUNT=0
        for release in $ALL_RELEASES; do
          COUNT=$((COUNT+1))
          if [ $COUNT -gt 20 ]; then
            echo "åˆ é™¤æ—§å‘å¸ƒ: $release"
            curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$release"
          fi
        done

    - name: ç¼–è¯‘æˆåŠŸä¿¡æ¯é€šçŸ¥-Telegram
      if: success()
      run: |
        echo "å‘é€Telegramé€šçŸ¥..."
        BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        MESSAGE="âœ… OpenWrtç¼–è¯‘æˆåŠŸï¼%0A%0AğŸ“… ç¼–è¯‘æ—¶é—´: $BUILD_TIME%0AğŸ“¦ ä»“åº“: ${{ github.repository }}%0AğŸ”– ç‰ˆæœ¬: $(cd openwrt && git log -1 --pretty=format:'%h')%0A%0Aä¸‹è½½åœ°å€: $GITHUB_RELEASE"
        
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="$MESSAGE" \
          -d parse_mode="HTML"

    - name: ç¼–è¯‘å¤±è´¥ä¿¡æ¯é€šçŸ¥-Telegram
      if: failure()
      run: |
        echo "å‘é€Telegramå¤±è´¥é€šçŸ¥..."
        BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        MESSAGE="âŒ OpenWrtç¼–è¯‘å¤±è´¥ï¼%0A%0AğŸ“… ç¼–è¯‘æ—¶é—´: $BUILD_TIME%0AğŸ“¦ ä»“åº“: ${{ github.repository }}%0A%0Aè¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
        
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="$MESSAGE" \
          -d parse_mode="HTML"
